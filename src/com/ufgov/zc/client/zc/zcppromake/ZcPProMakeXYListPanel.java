package com.ufgov.zc.client.zc.zcppromake;import java.awt.Color;import java.awt.Container;import java.awt.Font;import java.awt.event.MouseAdapter;import java.awt.event.MouseEvent;import java.math.BigDecimal;import java.text.DecimalFormat;import java.util.ArrayList;import java.util.Date;import java.util.List;import javax.swing.BorderFactory;import javax.swing.JComponent;import javax.swing.JFrame;import javax.swing.JOptionPane;import javax.swing.SwingUtilities;import javax.swing.UIManager;import javax.swing.border.TitledBorder;import javax.swing.table.TableModel;import org.apache.commons.lang.ObjectUtils;import org.apache.log4j.Logger;import com.ufgov.smartclient.common.DefaultInvokeHandler;import com.ufgov.smartclient.common.UIUtilities;import com.ufgov.smartclient.component.table.JGroupableTable;import com.ufgov.smartclient.component.table.TableRowHeader.CheckedEvent;import com.ufgov.smartclient.component.table.TableRowHeader.CheckedListener;import com.ufgov.smartclient.plaf.BlueLookAndFeel;import com.ufgov.zc.client.common.AsOptionMeta;import com.ufgov.zc.client.common.BillElementMeta;import com.ufgov.zc.client.common.LangTransMeta;import com.ufgov.zc.client.common.ListCursor;import com.ufgov.zc.client.common.MyTableModel;import com.ufgov.zc.client.common.WorkEnv;import com.ufgov.zc.client.common.XySpecialBrandMeta;import com.ufgov.zc.client.common.converter.zc.ZcPProMakeToTableModelConverter;import com.ufgov.zc.client.component.GkBaseDialog;import com.ufgov.zc.client.component.event.ValueChangeEvent;import com.ufgov.zc.client.component.event.ValueChangeListener;import com.ufgov.zc.client.component.ui.AbstractSearchConditionArea;import com.ufgov.zc.client.component.ui.MultiDataDisplay;import com.ufgov.zc.client.component.ui.SummarizedResultPanel;import com.ufgov.zc.client.component.ui.TableDisplay;import com.ufgov.zc.client.component.ui.conditionitem.AbstractSearchConditionItem;import com.ufgov.zc.client.util.ListUtil;import com.ufgov.zc.client.zc.ZcUtil;import com.ufgov.zc.common.commonbiz.model.BillElement;import com.ufgov.zc.common.system.constants.ZcElementConstants;import com.ufgov.zc.common.system.constants.ZcSettingConstants;import com.ufgov.zc.common.system.dto.ElementConditionDto;import com.ufgov.zc.common.system.util.ObjectUtil;import com.ufgov.zc.common.zc.model.ZcBMerchandise;import com.ufgov.zc.common.zc.model.ZcPProMake;import com.ufgov.zc.common.zc.model.ZcPProMitem;import com.ufgov.zc.common.zc.model.ZcPProMitemBi;@SuppressWarnings("unchecked")public class ZcPProMakeXYListPanel extends ZcPProMakeListPanel {  private static final long serialVersionUID = 1277810469937954543L;  public static final Logger logger = Logger.getLogger(ZcPProMakeXYListPanel.class); /* //协议供货预算限额  BigDecimal moneyLimit = new BigDecimal("".equals(AsOptionMeta.getOptVal("OPT_ZC_XY_MONEY_LIMIT")) ? "0": AsOptionMeta.getOptVal("OPT_ZC_XY_MONEY_LIMIT"));  BigDecimal moneyLimitTs = new BigDecimal("".equals(AsOptionMeta.getOptVal("OPT_ZC_XY_MONEY_LIMIT_TS")) ? "0": AsOptionMeta.getOptVal("OPT_ZC_XY_MONEY_LIMIT_TS"));*/  public String getCompoId() {    return "ZC_P_PRO_MAKE_XY";  }  public String getTabId() {    return ZcSettingConstants.TAB_ID_ZC_P_PRO_MAKE_XY;  }  public String getTitle() {    return LangTransMeta.translate(ZcElementConstants.FIELD_TRANS_ZC_MAKE_XY_TITEL);  }  public ZcPProMakeEditPanel getEditPanel(GkBaseDialog parent, ListCursor listCursor, String tabStatus, ZcPProMakeListPanel listPanel) {    return new ZcPProMakeXYEditPanel(parent, listCursor, tabStatus, listPanel);  }  public final class DataDisplay extends MultiDataDisplay {    public DataDisplay(List<TableDisplay> displays, List<TableDisplay> showingDisplays, AbstractSearchConditionArea conditionArea,    boolean showConditionArea) {      super(displays, showingDisplays, conditionArea, showConditionArea, getTabId());      setBorder(BorderFactory.createTitledBorder(BorderFactory.createEtchedBorder(), getTitle(), TitledBorder.CENTER, TitledBorder.TOP, new Font(      "宋体", Font.BOLD, 15), Color.BLUE));    }    protected void preprocessShowingTableDisplay(List<TableDisplay> showingTableDisplays) {      for (final TableDisplay d : showingTableDisplays) {        final JGroupableTable table = d.getTable();        table.addMouseListener(new MouseAdapter() {          public void mouseClicked(MouseEvent e) {            if (e.getClickCount() == 2 && SwingUtilities.isLeftMouseButton(e)) {              String tabStatus = d.getStatus();              JGroupableTable table = d.getTable();              MyTableModel model = (MyTableModel) table.getModel();              int row = table.getSelectedRow();              List viewList = (List) ObjectUtil.deepCopy(ListUtil.convertToTableViewOrderList(model.getList(), table));              new ZcPProMakeDialog(self, viewList, row, tabStatus);            }          }        });        //合计信息        List sumFields = new ArrayList();        sumFields.add(LangTransMeta.translate(ZcElementConstants.FIELD_TRANS_ZC_MONEY_BI_SUM));        d.setSummarizedResultPanel(new SummarizedResultPanel(d.getTable(), sumFields));        final JGroupableTable jTable = d.getTable();        jTable.getTableRowHeader().addCheckedListener(new CheckedListener() {          public void checkedChanged(CheckedEvent e) {            d.getSummarizedResultPanel().clearSummarizedResult();            d.getSummarizedResultPanel().refreshSummarizedResult();          }        });        d.addSorterValueChangeListener(new ValueChangeListener() {          public void valueChanged(ValueChangeEvent e) {            d.getSummarizedResultPanel().clearSummarizedResult();            d.getSummarizedResultPanel().refreshSummarizedResult();          }        });      }    }    @Override    protected void handleTableDisplayActived(AbstractSearchConditionItem[] searchConditionItems, final TableDisplay tableDisplay) {      elementConditionDto.setWfcompoId(getCompoId());      elementConditionDto.setExecutor(WorkEnv.getInstance().getCurrUserId());      elementConditionDto.setNd(WorkEnv.getInstance().getTransNd());      elementConditionDto.setStatus(tableDisplay.getStatus());      elementConditionDto.setZcText0(WorkEnv.getInstance().getCurrUserId());      setElementConditionDto(elementConditionDto);      for (AbstractSearchConditionItem item : searchConditionItems) {        item.putToElementConditionDto(elementConditionDto);      }      final Container c = tableDisplay.getTable().getParent();      UIUtilities.asyncInvoke(new DefaultInvokeHandler<TableModel>() {        @Override        public void before() {          assert c != null;          installLoadingComponent(c);        }        @Override        public void after() {          assert c != null;          unInstallLoadingComponent(c);          c.add(tableDisplay.getTable());        }        @Override        public TableModel execute() throws Exception {          if (getCompoId().equals("ZC_P_PRO_MAKE_XY")) {            return ZcPProMakeToTableModelConverter.convertToTableModelXieYi(self.ZcPProMakeServiceDelegate.getZcPProMake(elementConditionDto,requestMeta));          }          return ZcPProMakeToTableModelConverter.convertToTableModel(self.ZcPProMakeServiceDelegate.getZcPProMake(elementConditionDto, requestMeta));        }        @Override        public void success(TableModel model) {          tableDisplay.setTableModel(model);          setButtonStatus();          //刷新合计行          tableDisplay.getSummarizedResultPanel().clearSummarizedResult();          tableDisplay.getSummarizedResultPanel().refreshSummarizedResult();        }      });    }  }  public void setElementConditionDto(ElementConditionDto dto) {    // 协议供货    dto.setZcText2(ZcPProMake.CAIGOU_TYPE_XIEYI);  }  /**   * 保存前校验   * @param cpApply   * @return   */  public boolean checkBeforeSave(ZcPProMake zcPProMake, JComponent panel) {    List mainNotNullList = new ArrayList();    List itemNotNullList = new ArrayList();    List biNotNullList = new ArrayList();    List merNotNullList = new ArrayList();    mainNotNullList = ((BillElementMeta) billElementMeta).getNotNullBillElement();     itemNotNullList = itemBillElementMerMeta.getNotNullBillElement();    biNotNullList = biBillElementMeta.getNotNullBillElement();     StringBuilder errorInfo = new StringBuilder();    String mainValidateInfo = ZcUtil.validateBillElementNull(zcPProMake, mainNotNullList);    String biValidateInfo = ZcUtil.validateDetailBillElementNull(zcPProMake.getBiList(), biNotNullList, false);    String itemValidateInfo = ZcUtil.validateDetailBillElementNull(zcPProMake.getItemList(), itemNotNullList, false);    String peijianStr=ZcUtil.validateDetailBillElementNull(zcPProMake.getPeiJianList(), itemNotNullList, false);         if (mainValidateInfo.length() != 0) {      errorInfo.append(LangTransMeta.translate(ZcElementConstants.FIELD_TRANS_ZC_MAKE_XY_TITEL)).append("：\n").append(mainValidateInfo.toString()).append("\n");    }    //当采购类型为电子竞价时对电子截止时间非空的判断  add by humina        Date date = zcPProMake.getZcXieYiEndDate();        if (zcPProMake.getZcFukuanType().equals("G03") && date == null) {          errorInfo.append("请填写报价截止时间！").append("\n");        }    if (ZcUtil.useBudget() && biValidateInfo.length() == 0) {      biValidateInfo = checkBiMoney(zcPProMake.getBiList());    }    if (biValidateInfo.length() != 0) {      errorInfo.append("资金构成：\n").append(biValidateInfo.toString()).append("\n"); //wangwei notes 2011-04-07-23:17    }    if (itemValidateInfo.length() != 0) {      errorInfo.append("商品和配件明细：\n").append(itemValidateInfo.toString()).append("\n");    }      List<ZcPProMitem> mitems = zcPProMake.getItemList();    for (ZcPProMitem it : mitems) {      if (it.getZcCaigNum() == null || it.getZcCaigNum().intValue() == 0) {        errorInfo.append("计划明细 采购数量 必须填写！").append("\n");      }     }    //计划明细总和    BigDecimal sum = new BigDecimal(0);    for (Object o : zcPProMake.getBiList()) {      ZcPProMitemBi item = (ZcPProMitemBi) o;      BigDecimal jihuaSum = (BigDecimal) ObjectUtils.defaultIfNull(item.getZcBiJhuaSum(), new BigDecimal(0));      sum = sum.add(jihuaSum);    }    DecimalFormat df = new DecimalFormat("0.00");    if (!(df.format(sum)).equals(df.format(zcPProMake.getZcMoneyBiSum()))) {      errorInfo.append("本次采购使用金额合计必须等于采购预算！\n");    }      if (errorInfo.length() != 0) {      JOptionPane.showMessageDialog(panel, errorInfo.toString(), "提示", JOptionPane.WARNING_MESSAGE);      return true;    }    return false;  }     public static void main(String[] args) throws Exception {    SwingUtilities.invokeLater(new Runnable() {      public void run() {        try {          UIManager.setLookAndFeel(UIManager.getSystemLookAndFeelClassName());          UIManager.setLookAndFeel(new BlueLookAndFeel());        } catch (Exception e) {          e.printStackTrace();        }        ZcPProMakeXYListPanel bill = new ZcPProMakeXYListPanel();        JFrame frame = new JFrame("frame");        frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);        frame.setSize(800, 600);        frame.setLocationRelativeTo(null);        frame.getContentPane().add(bill);        frame.setVisible(true);      }    });  }}